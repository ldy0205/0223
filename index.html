<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë•ë•ì´</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream:    #fdf6ec;
    --warm0:    #fff9f2;
    --warm1:    #fdebd0;
    --warm2:    #f5cba7;
    --amber:    #e8965a;
    --amber-d:  #c97a3f;
    --brown:    #7a4f2e;
    --brown-l:  #a07050;
    --sage:     #8aab90;
    --sage-l:   #c5ddc8;
    --surface:  #ffffff;
    --text:     #3d2b1f;
    --text-mid: #7a5c48;
    --text-dim: #b89a88;
    --border:   #e8d5c4;
    --shadow:   rgba(122,79,46,0.10);
  }

  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

  html, body { height:100%; background:var(--cream); color:var(--text); font-family:'Gowun Dodum',serif; overflow:hidden; }

  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(ellipse 80% 60% at 10% 0%,  rgba(253,235,208,.7) 0%, transparent 60%),
      radial-gradient(ellipse 60% 50% at 90% 100%, rgba(197,221,200,.4) 0%, transparent 60%),
      radial-gradient(ellipse 50% 40% at 80% 10%,  rgba(232,150,90,.08) 0%, transparent 55%);
  }

  /* â”€â”€ LAYOUT â”€â”€ */
  .app {
    position:relative; z-index:1;
    height:100dvh;
    display:grid;
    grid-template-rows:auto 1fr auto;
    max-width:780px;
    margin:0 auto;
    padding:0 1rem;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display:flex; align-items:center; justify-content:space-between;
    padding:1.1rem 0 0.8rem;
    border-bottom:1px solid var(--border);
    gap:1rem;
  }

  .haru-identity { display:flex; align-items:center; gap:.9rem; }

  .haru-avatar {
    width:46px; height:46px; border-radius:50%;
    background:linear-gradient(135deg,var(--warm2),var(--amber));
    display:flex; align-items:center; justify-content:center;
    font-size:1.4rem;
    box-shadow:0 4px 16px rgba(232,150,90,.35);
    position:relative; flex-shrink:0;
  }
  .haru-avatar::after {
    content:''; position:absolute; bottom:1px; right:1px;
    width:10px; height:10px; border-radius:50%;
    background:var(--sage); border:2px solid var(--cream);
  }

  .haru-name { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--brown); line-height:1; }
  .haru-status { font-size:.72rem; color:var(--sage); margin-top:.2rem; letter-spacing:.03em; }

  .clear-btn {
    background:transparent; border:1px solid var(--border); border-radius:100px;
    padding:.4rem .9rem; font-size:.75rem; color:var(--text-dim);
    cursor:pointer; transition:all .2s; font-family:'Gowun Dodum',serif;
  }
  .clear-btn:hover { background:var(--warm1); color:var(--text-mid); border-color:var(--amber); }

  /* â”€â”€ MESSAGES â”€â”€ */
  .messages {
    overflow-y:auto; padding:1.5rem 0;
    display:flex; flex-direction:column; gap:1.2rem;
    scrollbar-width:thin; scrollbar-color:var(--border) transparent;
  }
  .messages::-webkit-scrollbar { width:4px; }
  .messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

  /* â”€â”€ MSG ROW â”€â”€ */
  .msg-row {
    display:flex; align-items:flex-end; gap:.65rem;
    animation:msgIn .35s cubic-bezier(.22,.68,0,1.2) both;
  }
  @keyframes msgIn {
    from { opacity:0; transform:translateY(14px) scale(.97); }
    to   { opacity:1; transform:translateY(0) scale(1); }
  }
  .msg-row.user { flex-direction:row-reverse; }

  .msg-avatar {
    width:30px; height:30px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    font-size:.85rem; flex-shrink:0; margin-bottom:2px;
  }
  .ai-avatar   { background:linear-gradient(135deg,var(--warm2),var(--amber)); }
  .user-avatar { background:linear-gradient(135deg,var(--sage-l),var(--sage)); }

  .bubble {
    max-width:min(68%,520px);
    padding:.85rem 1.15rem;
    border-radius:18px;
    line-height:1.75; font-size:.925rem;
  }
  .msg-row.ai .bubble {
    background:var(--surface); border:1px solid var(--border);
    border-bottom-left-radius:6px; box-shadow:0 2px 12px var(--shadow); color:var(--text);
  }
  .msg-row.user .bubble {
    background:linear-gradient(135deg,var(--amber),var(--amber-d));
    color:#fff; border-bottom-right-radius:6px;
    box-shadow:0 4px 18px rgba(232,150,90,.4);
  }
  .bubble time {
    display:block; font-size:.65rem; margin-top:.4rem;
    opacity:.5; font-family:'DM Mono',monospace;
  }

  /* markdown */
  .bubble strong { font-weight:700; }
  .bubble em { font-style:italic; }
  .bubble code {
    background:rgba(122,79,46,.08); padding:.1em .4em;
    border-radius:4px; font-family:'DM Mono',monospace; font-size:.82em;
  }
  .msg-row.user .bubble code { background:rgba(255,255,255,.2); }
  .bubble ul, .bubble ol { padding-left:1.4em; margin:.4em 0; }
  .bubble li { margin-bottom:.2em; }
  .bubble p + p { margin-top:.5em; }

  /* â”€â”€ TYPING â”€â”€ */
  .typing-row { display:none; }
  .typing-row.show { display:flex; }
  .typing-bubble {
    background:var(--surface); border:1px solid var(--border);
    border-radius:18px; border-bottom-left-radius:6px;
    padding:.85rem 1.1rem; display:flex; align-items:center; gap:5px;
    box-shadow:0 2px 12px var(--shadow);
  }
  .typing-dot {
    width:7px; height:7px; border-radius:50%;
    background:var(--amber); animation:bounce 1.2s infinite;
  }
  .typing-dot:nth-child(2) { animation-delay:.18s; background:var(--amber-d); }
  .typing-dot:nth-child(3) { animation-delay:.36s; background:var(--sage); }
  @keyframes bounce {
    0%,60%,100% { transform:translateY(0); }
    30%         { transform:translateY(-7px); }
  }

  /* â”€â”€ WELCOME â”€â”€ */
  .welcome {
    display:flex; flex-direction:column; align-items:center;
    justify-content:center; text-align:center; gap:1.2rem; padding:2rem 1rem;
  }
  .welcome-icon {
    width:72px; height:72px; border-radius:50%;
    background:linear-gradient(135deg,var(--warm2),var(--amber));
    display:flex; align-items:center; justify-content:center; font-size:2rem;
    box-shadow:0 8px 30px rgba(232,150,90,.35);
    animation:floatIcon 3s ease-in-out infinite;
  }
  @keyframes floatIcon {
    0%,100% { transform:translateY(0); } 50% { transform:translateY(-8px); }
  }
  .welcome h2 { font-family:'DM Serif Display',serif; font-size:1.6rem; color:var(--brown); }
  .welcome p { font-size:.9rem; color:var(--text-mid); max-width:340px; line-height:1.7; }
  .welcome-chips { display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center; margin-top:.3rem; }
  .chip {
    background:var(--surface); border:1px solid var(--border); border-radius:100px;
    padding:.45rem 1rem; font-size:.8rem; color:var(--text-mid);
    cursor:pointer; transition:all .2s;
  }
  .chip:hover { background:var(--warm1); border-color:var(--amber); color:var(--brown); transform:translateY(-2px); }

  /* â”€â”€ INPUT â”€â”€ */
  .input-area { padding:.8rem 0 1.2rem; border-top:1px solid var(--border); }
  .input-wrap {
    display:flex; align-items:flex-end; gap:.6rem;
    background:var(--surface); border:1.5px solid var(--border); border-radius:22px;
    padding:.55rem .6rem .55rem 1.1rem; transition:border-color .2s, box-shadow .2s;
  }
  .input-wrap:focus-within { border-color:var(--amber); box-shadow:0 0 0 4px rgba(232,150,90,.12); }
  #userInput {
    flex:1; background:none; border:none; outline:none;
    font-family:'Gowun Dodum',serif; font-size:.92rem; color:var(--text);
    line-height:1.6; resize:none; max-height:130px; overflow-y:auto;
  }
  #userInput::placeholder { color:var(--text-dim); }
  .send-btn {
    width:40px; height:40px; border-radius:50%;
    background:linear-gradient(135deg,var(--amber),var(--amber-d));
    border:none; color:#fff; font-size:1.05rem; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    transition:all .2s; flex-shrink:0;
    box-shadow:0 3px 10px rgba(232,150,90,.4);
  }
  .send-btn:hover { transform:scale(1.08); box-shadow:0 5px 16px rgba(232,150,90,.55); }
  .send-btn:active { transform:scale(.95); }
  .send-btn:disabled { opacity:.45; cursor:not-allowed; transform:none; }
  .input-hint { text-align:center; font-size:.67rem; color:var(--text-dim); margin-top:.55rem; font-family:'DM Mono',monospace; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position:fixed; bottom:100px; left:50%;
    transform:translateX(-50%) translateY(20px);
    background:#fff0ec; border:1px solid #f5c6a8; color:#8b4513;
    border-radius:12px; padding:.65rem 1.2rem; font-size:.82rem;
    box-shadow:0 8px 24px rgba(0,0,0,.1); z-index:500;
    opacity:0; transition:all .3s; pointer-events:none; white-space:nowrap;
  }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  @media (max-width:480px) {
    .bubble { max-width:85%; font-size:.88rem; }
    .haru-name { font-size:1.1rem; }
  }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="haru-identity">
      <div class="haru-avatar">ğŸ¾</div>
      <div>
        <div class="haru-name">ë•ë•ì´</div>
        <div class="haru-status" id="statusText">â— ëŒ€ê¸° ì¤‘</div>
      </div>
    </div>
    <button class="clear-btn" onclick="clearChat()">ìƒˆ ëŒ€í™” âœ¨</button>
  </header>

  <div class="messages" id="messages">
    <div class="welcome" id="welcome">
      <div class="welcome-icon">ğŸ¾</div>
      <h2>ì–´, ì™”ì–´? ë‚˜ ë•ë•ì´ì•¼ ğŸ¾</h2>
      <p>ë­ ê¶ê¸ˆí•œ ê±° ìˆì–´? ê·¸ëƒ¥ ë§ ê±¸ì–´ë„ ë¼.</p>
      <div class="welcome-chips">
        <div class="chip" onclick="sendChip(this)">ì˜¤ëŠ˜ í•  ì¼ ì •ë¦¬ ë„ì™€ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ê¸°ë¶„ ì „í™˜ ë°©ë²• ì•Œë ¤ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì˜ì–´ ì´ë©”ì¼ ì¨ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì¬ë¯¸ìˆëŠ” ì–˜ê¸° í•´ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì½”ë“œ ë¦¬ë·° í•´ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì¢‹ì€ ì±… ì¶”ì²œí•´ì¤˜</div>
      </div>
    </div>
    <div class="msg-row typing-row" id="typingRow">
      <div class="msg-avatar ai-avatar">ğŸ¾</div>
      <div class="typing-bubble">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrap">
      <textarea id="userInput" placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš” âœ¨" rows="1"
        oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
    </div>
    <div class="input-hint">Enter ì „ì†¡ Â· Shift+Enter ì¤„ë°”ê¿ˆ</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let chatHistory = [];
let isLoading   = false;

// Netlify Function ì—”ë“œí¬ì¸íŠ¸ (ê°™ì€ ë„ë©”ì¸ì´ë¼ í‚¤ ë…¸ì¶œ ì—†ìŒ)
const API_ENDPOINT = '/.netlify/functions/chat';

function getTime() {
  return new Date().toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit' });
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 130) + 'px';
}

function scrollBottom() {
  const m = document.getElementById('messages');
  m.scrollTo({ top: m.scrollHeight, behavior:'smooth' });
}

function showToast(msg, duration = 3500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function renderMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,     '<em>$1</em>')
    .replace(/`([^`]+)`/g,     '<code>$1</code>')
    .replace(/^[â€¢\-\*] (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/\n/g, '<br>');
}

function hideWelcome() {
  const w = document.getElementById('welcome');
  if (w) w.remove();
}

function addBubble(role, text) {
  const container  = document.getElementById('messages');
  const typingRow  = document.getElementById('typingRow');

  const row = document.createElement('div');
  row.className = `msg-row ${role}`;

  const avatar = document.createElement('div');
  avatar.className = `msg-avatar ${role === 'ai' ? 'ai-avatar' : 'user-avatar'}`;
  avatar.textContent = role === 'ai' ? 'ğŸ¾' : 'ğŸ™‚';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = renderMarkdown(text) + `<time>${getTime()}</time>`;

  row.appendChild(avatar);
  row.appendChild(bubble);
  container.insertBefore(row, typingRow);
  scrollBottom();
}

function setTyping(show) {
  document.getElementById('typingRow').classList.toggle('show', show);
  scrollBottom();
}

function setLoading(v) {
  isLoading = v;
  document.getElementById('sendBtn').disabled  = v;
  document.getElementById('userInput').disabled = v;
  document.getElementById('statusText').textContent =
    v ? 'â— ìƒê°í•˜ëŠ” ì¤‘...' : 'â— ëŒ€ê¸° ì¤‘';
}

async function sendMessage(text) {
  const input    = document.getElementById('userInput');
  const userText = (text ?? input.value).trim();
  if (!userText || isLoading) return;

  hideWelcome();
  input.value = '';
  input.style.height = 'auto';

  addBubble('user', userText);
  chatHistory.push({ role:'user', content:userText });

  setLoading(true);
  setTyping(true);

  try {
    const res = await fetch(API_ENDPOINT, {
      method:  'POST',
      headers: { 'Content-Type':'application/json' },
      body:    JSON.stringify({ messages: chatHistory }),
    });

    // res.json() ëŒ€ì‹  textë¡œ ë¨¼ì € ë°›ì•„ì„œ íŒŒì‹± â€” ë¹ˆ ì‘ë‹µ ë°©ì–´
    const raw = await res.text();

    if (!raw || raw.trim() === '') {
      throw new Error(`ì„œë²„ ì‘ë‹µì´ ë¹„ì–´ìˆì–´ (HTTP ${res.status}). Netlify í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY í™•ì¸í•´ë´.`);
    }

    let data;
    try { data = JSON.parse(raw); }
    catch { throw new Error('ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ' + raw.slice(0, 120)); }

    if (!res.ok) throw new Error(data?.error || 'HTTP ' + res.status);

    const reply = data.reply;
    if (!reply) throw new Error('ì‘ë‹µì´ ë¹„ì–´ìˆì–´. ì ê¹ ë’¤ì— ë‹¤ì‹œ í•´ë´.');

    chatHistory.push({ role:'assistant', content:reply });
    setTyping(false);
    addBubble('ai', reply);

  } catch (err) {
    setTyping(false);
    const msg = err.message.includes('Failed to fetch')
      ? 'Netlify Function ì—°ê²° ì‹¤íŒ¨. ë°°í¬ ìƒíƒœ í™•ì¸í•´ë´.'
      : err.message;
    addBubble('ai', msg);
    showToast('âš ï¸ ' + msg);
  } finally {
    setLoading(false);
    input.focus();
  }
}

function sendChip(el) { sendMessage(el.textContent); }

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function clearChat() {
  chatHistory = [];
  const container = document.getElementById('messages');
  container.querySelectorAll('.msg-row:not(#typingRow)').forEach(r => r.remove());

  if (!document.getElementById('welcome')) {
    const w = document.createElement('div');
    w.id = 'welcome'; w.className = 'welcome';
    w.innerHTML = `
      <div class="welcome-icon">ğŸ¾</div>
      <h2>ì–´, ì™”ì–´? ë‚˜ ë•ë•ì´ì•¼ ğŸ¾</h2>
      <p>ë­ ê¶ê¸ˆí•œ ê±° ìˆì–´? ê·¸ëƒ¥ ë§ ê±¸ì–´ë„ ë¼.</p>
      <div class="welcome-chips">
        <div class="chip" onclick="sendChip(this)">ì˜¤ëŠ˜ í•  ì¼ ì •ë¦¬ ë„ì™€ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ê¸°ë¶„ ì „í™˜ ë°©ë²• ì•Œë ¤ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì˜ì–´ ì´ë©”ì¼ ì¨ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì¬ë¯¸ìˆëŠ” ì–˜ê¸° í•´ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì½”ë“œ ë¦¬ë·° í•´ì¤˜</div>
        <div class="chip" onclick="sendChip(this)">ì¢‹ì€ ì±… ì¶”ì²œí•´ì¤˜</div>
      </div>`;
    container.insertBefore(w, document.getElementById('typingRow'));
  }
  showToast('ğŸ¾ ìƒˆ ëŒ€í™” ì‹œì‘!');
}

document.getElementById('userInput').focus();
</script>
</body>
</html>
