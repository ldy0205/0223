<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë•ë•ì´</title>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #fdf6ec; --warm2: #f5cba7; --amber: #e8965a;
      --brown: #7a4f2e; --sage: #8aab90; --border: #e8d5c4;
      --text: #3d2b1f; --shadow: rgba(122,79,46,0.1);
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--cream); color:var(--text); font-family:'Gowun Dodum', sans-serif; height:100dvh; overflow:hidden; }
    .app { max-width:780px; margin:0 auto; height:100%; display:grid; grid-template-rows:auto 1fr auto; padding:0 1rem; }
    header { padding:1rem 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .messages { overflow-y:auto; padding:1.5rem 0; display:flex; flex-direction:column; gap:1rem; }
    .msg-row { display:flex; gap:0.5rem; align-items:flex-end; margin-bottom:0.5rem; }
    .msg-row.user { flex-direction:row-reverse; }
    .bubble { max-width:75%; padding:0.8rem 1rem; border-radius:15px; font-size:0.95rem; line-height:1.5; }
    .msg-row.ai .bubble { background:white; border:1px solid var(--border); }
    .msg-row.user .bubble { background:var(--amber); color:white; }
    .input-area { padding:1rem 0; }
    .input-box { background:white; border:1.5px solid var(--border); border-radius:25px; padding:0.5rem 1rem; display:flex; gap:0.5rem; }
    textarea { flex:1; border:none; outline:none; resize:none; font-family:inherit; font-size:1rem; }
    .send-btn { background:var(--amber); color:white; border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; }
    .typing { font-size:0.8rem; color:var(--amber); margin-left:40px; display:none; }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <span style="font-size:1.5rem;">ğŸ¾</span>
      <strong style="color:var(--brown)">DUCK-DUCK</strong>
    </div>
    <button onclick="location.reload()" style="font-size:0.8rem; cursor:pointer; background:none; border:1px solid var(--border); border-radius:10px; padding:2px 8px;">ì´ˆê¸°í™”</button>
  </header>

  <main class="messages" id="messages">
    <div id="welcome" style="text-align:center; padding:2rem;">
      <h2>ë°˜ê°€ì›Œ! ë‚˜ ë•ë•ì´ì•¼ ğŸ¾</h2>
      <p>ì•„ë¬´ ë§ì´ë‚˜ ê±¸ì–´ë´!</p>
    </div>
  </main>
  
  <div id="typingIndicator" class="typing">ë•ë•ì´ê°€ ìƒê° ì¤‘...</div>

  <footer class="input-area">
    <div class="input-box">
      <textarea id="chatInput" placeholder="ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•´..." rows="1"></textarea>
      <button class="send-btn" onclick="handleSend()">â”</button>
    </div>
  </footer>
</div>

<script>
let chatHistory = [];
const input = document.getElementById('chatInput');
const container = document.getElementById('messages');
const typing = document.getElementById('typingIndicator');

async function handleSend() {
  const text = input.value.trim();
  if (!text) return;

  // 1. ì‚¬ìš©ì í™”ë©´ì— í‘œì‹œ
  input.value = '';
  if(document.getElementById('welcome')) document.getElementById('welcome').remove();
  addBubble('user', text);
  
  // 2. íˆìŠ¤í† ë¦¬ ê¸°ë¡
  chatHistory.push({ role: "user", content: text });
  
  // 3. ì„œë²„ ì „ì†¡
  typing.style.display = 'block';
  try {
    const response = await fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json' // ì´ í—¤ë”ê°€ ì—†ìœ¼ë©´ ì„œë²„ê°€ ë°ì´í„°ë¥¼ ëª» ì½ìŠµë‹ˆë‹¤
      },
      body: JSON.stringify({ messages: chatHistory })
    });

    if (!response.ok) {
      // ì„œë²„ ì—ëŸ¬ ìƒì„¸ í™•ì¸
      const errorText = await response.text();
      throw new Error(`ì„œë²„ ìƒíƒœ: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const aiMsg = data.choices[0].message.content;

    addBubble('ai', aiMsg);
    chatHistory.push({ role: "assistant", content: aiMsg });

  } catch (err) {
    console.error(err);
    addBubble('ai', "âš ï¸ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
  } finally {
    typing.style.display = 'none';
    container.scrollTop = container.scrollHeight;
  }
}

function addBubble(role, text) {
  const row = document.createElement('div');
  row.className = `msg-row ${role}`;
  row.innerHTML = `
    <div class="bubble">${text}</div>
  `;
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

// ì—”í„°í‚¤ ì „ì†¡ ê¸°ëŠ¥
input.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleSend();
  }
});
</script>
</body>
</html>